<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TempMail & TempNumber Dashboard</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div id="dashboard-section" class="section active">
    <h2>Dashboard</h2>
    <button id="generate-temp-email">Generate TempMail</button>
    <button id="generate-temp-number">Generate TempNumber</button>
    <button id="go-to-tempmail-inbox">Go to TempMail Inbox</button>
    <button id="go-to-tempnumber-inbox">Go to TempNumber Inbox</button>
    <button id="logout-button">Logout</button>
    <p id="generated-email"></p>
    <p id="generated-number"></p>
    <h3>History</h3>
    <div id="history-list"></div>
  </div>

  <div id="tempmail-inbox-section" class="section">
    <h2>TempMail Inbox</h2>
    <button id="back-to-dashboard">Back</button>
    <div id="mailbox-list"></div>
  </div>

  <div id="tempnumber-inbox-section" class="section">
    <h2>TempNumber Inbox</h2>
    <button id="back-to-dashboard-2">Back</button>
    <div id="sms-inbox-list"></div>
  </div>

  <script>
    const dashboardSection = document.getElementById('dashboard-section');
    const tempMailInboxSection = document.getElementById('tempmail-inbox-section');
    const tempNumberInboxSection = document.getElementById('tempnumber-inbox-section');

    const logoutButton = document.getElementById('logout-button');
    const historyList = document.getElementById('history-list');

    let tempEmail = '';
    let tempNumber = '';
    let emailHistory = JSON.parse(localStorage.getItem('emailHistory')) || [];
    let numberHistory = JSON.parse(localStorage.getItem('numberHistory')) || [];

    function updateHistory() {
      historyList.innerHTML = '';
      emailHistory.forEach(email => {
        const div = document.createElement('div');
        div.textContent = `TempMail: ${email}`;
        div.onclick = () => loadInbox(email);
        historyList.appendChild(div);
      });
      numberHistory.forEach(number => {
        const div = document.createElement('div');
        div.textContent = `TempNumber: ${number}`;
        div.onclick = () => loadSMSInbox(number);
        historyList.appendChild(div);
      });
    }

    logoutButton.onclick = () => {
      localStorage.clear();
      emailHistory = [];
      numberHistory = [];
      dashboardSection.classList.add('active');
      tempMailInboxSection.classList.remove('active');
      tempNumberInboxSection.classList.remove('active');
      updateHistory();
    };

    document.getElementById('generate-temp-email').onclick = async () => {
      const res = await fetch('/api/generate-email');
      const data = await res.json();
      tempEmail = data.email;
      emailHistory.push(tempEmail);
      localStorage.setItem('emailHistory', JSON.stringify(emailHistory));
      document.getElementById('generated-email').textContent = `TempMail: ${tempEmail}`;
      updateHistory();
    };

    document.getElementById('generate-temp-number').onclick = async () => {
      tempNumber = '+1' + Math.floor(1000000000 + Math.random() * 9000000000);
      numberHistory.push(tempNumber);
      localStorage.setItem('numberHistory', JSON.stringify(numberHistory));
      document.getElementById('generated-number').textContent = `TempNumber: ${tempNumber}`;
      updateHistory();
    };

    document.getElementById('go-to-tempmail-inbox').onclick = () => {
      if (!tempEmail) return alert('Generate a TempMail first!');
      dashboardSection.classList.remove('active');
      tempMailInboxSection.classList.add('active');
      loadInbox(tempEmail);
    };

    document.getElementById('go-to-tempnumber-inbox').onclick = () => {
      if (!tempNumber) return alert('Generate a TempNumber first!');
      dashboardSection.classList.remove('active');
      tempNumberInboxSection.classList.add('active');
      loadSMSInbox(tempNumber);
    };

    document.getElementById('back-to-dashboard').onclick = () => {
      tempMailInboxSection.classList.remove('active');
      dashboardSection.classList.add('active');
    };

    document.getElementById('back-to-dashboard-2').onclick = () => {
      tempNumberInboxSection.classList.remove('active');
      dashboardSection.classList.add('active');
    };

    async function loadInbox(email) {
      const [login, domain] = email.split('@');
      const mailboxList = document.getElementById('mailbox-list');
      mailboxList.innerHTML = 'Loading mails...';

      try {
        const res = await fetch(`/api/mailbox?login=${login}&domain=${domain}`);
        const messages = await res.json();
        mailboxList.innerHTML = messages.length === 0 
          ? '<p>No emails found.</p>' 
          : messages.map(msg => `<div class="mail-item" data-id="${msg.id}"><b>${msg.from}</b> - ${msg.subject}</div>`).join('');

        document.querySelectorAll('.mail-item').forEach(el => {
          el.onclick = async () => {
            const id = el.getAttribute('data-id');
            const msgRes = await fetch(`/api/mailbox/message?login=${login}&domain=${domain}&id=${id}`);
            const msgData = await msgRes.json();
            alert(`From: ${msgData.from}\nSubject: ${msgData.subject}\n\n${msgData.textBody || msgData.htmlBody}`);
          };
        });
      } catch (e) {
        mailboxList.innerHTML = '<p>Error loading mailbox.</p>';
      }
    }

    async function loadSMSInbox(number) {
      const smsInboxList = document.getElementById('sms-inbox-list');
      smsInboxList.innerHTML = 'Loading SMS inbox...';

      try {
        const res = await fetch(`/api/getsms/inbox?page=${encodeURIComponent(number)}`);
        const messages = await res.json();
        smsInboxList.innerHTML = messages.length === 0 
          ? '<p>No SMS found.</p>' 
          : messages.map(msg => `<div class="sms-item"><b>${msg.time}</b>: ${msg.text}</div>`).join('');
      } catch (e) {
        smsInboxList.innerHTML = '<p>Error loading SMS inbox.</p>';
      }
    }

    updateHistory();
  </script>
</body>
    </html>
