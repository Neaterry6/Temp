<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TempMail & TempNumber Dashboard</title>
  <style>
    body { font-family: sans-serif; background: #111; color: #eee; margin: 0; padding: 0; }
    .section { display: none; padding: 20px; }
    .active { display: block; }
    button { padding: 8px 16px; margin: 5px; cursor: pointer; background: #333; color: #eee; border: none; border-radius: 5px; }
    input { padding: 6px; margin: 5px 0; }
    .mail-item, .sms-item { margin: 10px 0; padding: 8px; background: #222; border-radius: 5px; cursor: pointer; }
    #history-list div { margin: 5px 0; padding: 5px; background: #222; border-radius: 4px; cursor: pointer; }
  </style>
</head>
<body>

<div id="auth-section" class="section active">
  <h2>Login / Signup</h2>
  <button id="login-tab" class="active">Login</button>
  <button id="signup-tab">Signup</button>
  <form id="auth-form">
    <input type="text" placeholder="Username" required><br>
    <input type="password" placeholder="Password" required><br>
    <button id="auth-submit">Login</button>
  </form>
</div>

<div id="dashboard-section" class="section">
  <h2>Dashboard</h2>
  <button id="generate-temp-email">Generate TempMail</button>
  <button id="generate-temp-number">Generate TempNumber</button>
  <button id="go-to-inbox">Go to Inbox</button>
  <button id="logout-button">Logout</button>

  <p id="generated-email"></p>
  <p id="generated-number"></p>

  <h3>History</h3>
  <div id="history-list"></div>
</div>

<div id="inbox-section" class="section">
  <h2>Inbox</h2>
  <button id="back-to-dashboard">Back</button>
  <h3>Emails</h3>
  <div id="mailbox-list"></div>
  <h3>SMS Messages</h3>
  <div id="sms-inbox-list"></div>
</div>

<script>
  const authSection = document.getElementById('auth-section');
  const dashboardSection = document.getElementById('dashboard-section');
  const inboxSection = document.getElementById('inbox-section');

  const loginTab = document.getElementById('login-tab');
  const signupTab = document.getElementById('signup-tab');
  const authForm = document.getElementById('auth-form');
  const authSubmit = document.getElementById('auth-submit');
  const logoutButton = document.getElementById('logout-button');

  let loggedIn = false;
  let tempEmail = '';
  let tempNumber = '';

  let emailHistory = JSON.parse(localStorage.getItem('emailHistory')) || [];
  let numberHistory = JSON.parse(localStorage.getItem('numberHistory')) || [];

  function updateHistory() {
    const historyList = document.getElementById('history-list');
    historyList.innerHTML = '';
    emailHistory.forEach(email => {
      const div = document.createElement('div');
      div.textContent = `TempMail: ${email}`;
      div.onclick = () => loadInbox(email);
      historyList.appendChild(div);
    });
    numberHistory.forEach(number => {
      const div = document.createElement('div');
      div.textContent = `TempNumber: ${number}`;
      div.onclick = () => loadSMSInbox(number);
      historyList.appendChild(div);
    });
  }

  loginTab.onclick = () => {
    loginTab.classList.add('active');
    signupTab.classList.remove('active');
    authSubmit.textContent = 'Login';
  };
  signupTab.onclick = () => {
    signupTab.classList.add('active');
    loginTab.classList.remove('active');
    authSubmit.textContent = 'Signup';
  };

  authForm.onsubmit = (e) => {
    e.preventDefault();
    loggedIn = true;
    authSection.classList.remove('active');
    dashboardSection.classList.add('active');
    updateHistory();
  };

  logoutButton.onclick = () => {
    loggedIn = false;
    authSection.classList.add('active');
    dashboardSection.classList.remove('active');
    inboxSection.classList.remove('active');
    localStorage.clear();
    emailHistory = [];
    numberHistory = [];
    updateHistory();
  };

  document.getElementById('generate-temp-email').onclick = async () => {
    const res = await fetch('/api/generate-email');
    const data = await res.json();
    tempEmail = data.email;
    emailHistory.push(tempEmail);
    localStorage.setItem('emailHistory', JSON.stringify(emailHistory));
    document.getElementById('generated-email').textContent = `TempMail: ${tempEmail}`;
    updateHistory();
  };

  document.getElementById('generate-temp-number').onclick = async () => {
    tempNumber = '+1' + Math.floor(1000000000 + Math.random() * 9000000000);
    numberHistory.push(tempNumber);
    localStorage.setItem('numberHistory', JSON.stringify(numberHistory));
    document.getElementById('generated-number').textContent = `TempNumber: ${tempNumber}`;
    updateHistory();
  };

  document.getElementById('go-to-inbox').onclick = () => {
    if (!tempEmail) return alert('Generate a TempMail first!');
    dashboardSection.classList.remove('active');
    inboxSection.classList.add('active');
    loadInbox(tempEmail);
  };

  document.getElementById('back-to-dashboard').onclick = () => {
    inboxSection.classList.remove('active');
    dashboardSection.classList.add('active');
  };

  async function loadInbox(email) {
    const [login, domain] = email.split('@');
    const mailboxList = document.getElementById('mailbox-list');
    const smsInboxList = document.getElementById('sms-inbox-list');
    mailboxList.innerHTML = 'Loading mails...';
    smsInboxList.innerHTML = '';

    try {
      const res = await fetch(`/api/mailbox?login=${login}&domain=${domain}`);
      const messages = await res.json();
      if (messages.length === 0) {
        mailboxList.innerHTML = '<p>No emails found.</p>';
        return;
      }
      mailboxList.innerHTML = messages.map(msg =>
        `<div class="mail-item" data-id="${msg.id}"><b>${msg.from}</b> - ${msg.subject}</div>`
      ).join('');
      document.querySelectorAll('.mail-item').forEach(el => {
        el.onclick = async () => {
          const id = el.getAttribute('data-id');
          const msgRes = await fetch(`/api/mailbox/message?login=${login}&domain=${domain}&id=${id}`);
          const msgData = await msgRes.json();
          alert(`From: ${msgData.from}\nSubject: ${msgData.subject}\n\n${msgData.textBody || msgData.htmlBody}`);
        };
      });
    } catch (e) {
      mailboxList.innerHTML = '<p>Error loading mailbox.</p>';
    }
  }

  async function loadSMSInbox(number) {
    const mailboxList = document.getElementById('mailbox-list');
    const smsInboxList = document.getElementById('sms-inbox-list');
    mailboxList.innerHTML = '';
    smsInboxList.innerHTML = 'Loading SMS inbox...';
    try {
      const res = await fetch(`/api/sms-inbox?number=${encodeURIComponent(number)}`);
      const messages = await res.json();
      if (messages.length === 0) {
        smsInboxList.innerHTML = '<p>No SMS found.</p>';
        return;
      }
      smsInboxList.innerHTML = messages.map(msg =>
        `<div class="sms-item"><b>${msg.from}</b>: ${msg.body}</div>`
      ).join('');
    } catch (e) {
      smsInboxList.innerHTML = '<p>Error loading SMS inbox.</p>';
    }
  }
</script>

</body>
  </html>
